rule Alan
{
    meta:
        author = "Antonio Blescia"
        os = "mswindows"
        filetype = "pe"
        maltype = "trojan"
        date = "2021/08/30"
    
    strings:
        $s1 = "JEhuVodiWr2/F9mixBcaAZTtjx4Rs9cJDLbpEG8i7hPKswcFdsn6MWwINP+Nwmw4AEPpVJevUEvRQbqVMVoLlw==" ascii
        $s2 = "original_session_key" ascii
        $s3 = "public_key" ascii
        $s4 = "request" ascii
        $s5 = "encrypt" ascii
        $s6 = "account" ascii
        $s7 = "content" ascii
        $s8 = "process_parent" ascii
        $s9 = "comment" ascii
        $s10 = "is_32_bit" ascii
        $s11 = "compress" ascii
        $s12 = "address" ascii
        $s13 = "servers" ascii
        $s14 = "adapters" ascii
        $s15 = "headers" ascii
        $s16 = "https" ascii
        $s17 = "addresses" ascii
        $s18 = "shares" ascii
        $s19 = "files" ascii
        $s20 = "cookies" ascii
        $s21 = "interfaces" ascii

        // Loads the configuration file from the VERSION_ID(10) Field
        // 0037876F | 6A 10                    | push 10                                           |
        // 00378771 | 6A 01                    | push 1                                            |
        // 00378773 | 56                       | push esi                                          |
        // 00378774 | FF15 2C2F3B00            | call dword ptr ds:[<&FindResourceA>]              |
        // 0037877A | 85C0                     | test eax,eax                                      | 
        $load_config_file = { 6A 10 6A 01 56 FF 15 [4] 85 C0 }
        $findResource = "FindResourceA"

        // Loads the module with x86PeLoader that will be executed in a separated thread
        // 003787ED | 68 10040000              | push 410                                          |
        // 003787F2 | 57                       | push edi                                          |
        // 003787F3 | 56                       | push esi                                          |
        // 003787F4 | FF15 902F3B00            | call dword ptr ds:[<&GetModuleFileNameA>]         |
        // 003787FA | 89D8                     | mov eax,ebx                                       | 
        // 003787FC | 83C0 20                  | add eax,20                                        | 
        $load_shellcode =      { 68 10 04 00 00 57 56 FF 15 [4] 89 D8 83 C0 20 }
        $getModuleFileNameA = "GetModuleFileNameA"

    condition:
        uint16(0) == 0x5A4D and
        ($load_config_file and $findResource) and
        ($load_shellcode and $getModuleFileNameA) and
        all of ($s*)

}