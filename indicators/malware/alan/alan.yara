rule Alan
{
    meta:
        author = "Antonio Blescia"
        os = "mswindows"
        filetype = "pe"
        maltype = "trojan"
        date = "2021/08/30"
    
    strings:
        $s1 = "JEhuVodiWr2/F9mixBcaAZTtjx4Rs9cJDLbpEG8i7hPKswcFdsn6MWwINP+Nwmw4AEPpVJevUEvRQbqVMVoLlw==" ascii
        $s2 = "original_session_key" ascii
        $s3 = "public_key" ascii
        $s4 = "request" ascii
        $s5 = "encrypt" ascii
        $s6 = "account" ascii
        $s7 = "content" ascii
        $s8 = "process_parent" ascii
        $s9 = "comment" ascii
        $s10 = "is_32_bit" ascii
        $s11 = "compress" ascii
        $s12 = "address" ascii
        $s13 = "servers" ascii
        $s14 = "adapters" ascii
        $s15 = "headers" ascii
        $s16 = "https" ascii
        $s17 = "addresses" ascii
        $s18 = "shares" ascii
        $s19 = "files" ascii
        $s20 = "cookies" ascii
        $s21 = "interfaces" ascii

        // Loads the configuration file from the VERSION_ID(10) Field
        // 0037876F | 6A 10                    | push 10                                           |
        // 00378771 | 6A 01                    | push 1                                            |
        // 00378773 | 56                       | push esi                                          |
        // 00378774 | FF15 2C2F3B00            | call dword ptr ds:[<&FindResourceA>]              |
        // 0037877A | 85C0                     | test eax,eax                                      | 
        $load_config_file = { 6A 10 6A 01 56 FF 15 [4] 85 C0 }
        $findResource = "FindResourceA"

        // Loads the module with x86PeLoader that will be executed in a separated thread
        // 003787ED | 68 10040000              | push 410                                          |
        // 003787F2 | 57                       | push edi                                          |
        // 003787F3 | 56                       | push esi                                          |
        // 003787F4 | FF15 902F3B00            | call dword ptr ds:[<&GetModuleFileNameA>]         |
        // 003787FA | 89D8                     | mov eax,ebx                                       | 
        // 003787FC | 83C0 20                  | add eax,20                                        | 
        $load_shellcode =      { 68 10 04 00 00 57 56 FF 15 [4] 89 D8 83 C0 20 }
        $getModuleFileNameA = "GetModuleFileNameA"

        // Spawns an hidden cmd istance(see dwCreationFlags)
        // https://docs.microsoft.com/en-us/windows/win32/procthread/process-creation-flags
        // .text:00016428 51                                                              push    ecx             ; lpProcessInformation
        // .text:00016429 52                                                              push    edx             ; lpStartupInfo
        // .text:0001642A 6A 00                                                           push    0               ; lpCurrentDirectory
        // .text:0001642C 50                                                              push    eax             ; lpEnvironment
        // .text:0001642D 68 00 00 08 08                                                  push    8080000h        ; dwCreationFlags
        // .text:00016432 6A 01                                                           push    1               ; bInheritHandles
        // .text:00016434 6A 00                                                           push    0               ; lpThreadAttributes
        // .text:00016436 6A 00                                                           push    0               ; lpProcessAttributes
        // .text:00016438 53                                                              push    ebx             ; lpCommandLine
        // .text:00016439 56                                                              push    esi             ; lpApplicationName
        // .text:0001643A FF 15 E4 2E 05 00                                               call    ds:CreateProcessA
        // .text:00016440 89 C7                                                           mov     edi, eax
        $spawn_hidden_cmd =      { 51 52 6A 00 50 68 00 00 08 08 6A 01 6A 00 6A 00 53 56 FF 15 [4] 89 C7 }
        $getModuleCreateProcessA = "CreateProcessA"

        // Alan implements a two step PPID spoofing.
        // In the first stage uses a full-duplex named pipe with a random name like this: \\.\pipe\i8mGpLB40EBBbbJK0Gxdu4O494o6EPp9
        // to communicate with the code injected in the target process.
        // After uses an anonymouse pipe.
        // .text:00017919 6A 00                                                           push    0               ; lpSecurityAttributes
        // .text:0001791B 53                                                              push    ebx             ; nDefaultTimeOut
        // .text:0001791C 68 00 40 00 00                                                  push    4000h           ; nInBufferSize
        // .text:00017921 68 00 40 00 00                                                  push    4000h           ; nOutBufferSize
        // .text:00017926 6A 01                                                           push    1               ; nMaxInstances
        // .text:00017928 6A 00                                                           push    0               ; dwPipeMode
        // .text:0001792A 6A 03                                                           push    3               ; dwOpenMode
        // .text:0001792C 57                                                              push    edi             ; lpName
        // .text:0001792D FF 15 DC 2E 05 00                                               call    ds:CreateNamedPipeA
        // .text:00017933 83 F8 FF                                                        cmp     eax, 0FFFFFFFFh
        $first_stage_ppid =      { 6A 00 53 68 00 40 00 00 68 00 40 00 00 6A 01 6A 00 6A 03 57 FF 15 [4] 83 F8 FF }
        $getModuleCreateNamedPipeA = "CreateNamedPipeA"
        
    condition:
        uint16(0) == 0x5A4D and
        ($load_config_file and $findResource) and
        ($load_shellcode and $getModuleFileNameA) and
        ($spawn_hidden_cmd and $getModuleCreateProcessA) and
        ($first_stage_ppid and $getModuleCreateNamedPipeA) and
        all of ($s*)

}